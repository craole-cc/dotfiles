#!/bin/sh

# ===================================================================
#@		                           	INFO			                       @#
# ===================================================================

__info__() {
  _cmd_PATH="$(realpath -s "$0")"
  _cmd_NAME="$(basename "$_cmd_PATH")"
  _cmd_HOME="$(dirname -- "$_cmd_NAME")"
  _cmd_VERSION="1.0"
  _cmd_DESCRIPTION="Allow the use of decimals in arithmetic equations"
  _cmd_DEPENDENCIES="(python or bc), printf, echo"
  _cmd_DEPENDENCIES_optional="weHave"
  _cmd_USAGEGUIDE="$(
    cat <<USAGE_GUIDE

#>----------------------------------------------------<#
                      USAGE: $_cmd_NAME
#>----------------------------------------------------<#
    $_cmd_DESCRIPTION
#>----------------------------------------------------<#
            command <[options]> <[arguments]>
          $_cmd_NAME --sentence "string to transform"
#>----------------------------------------------------<#
      -h --help       |>     Usage guide
      -v --version    |>     Version
      -d --verbose    |>     Details
      -p --python     |>     Use python [default]
      -b --bc         |>     Use bc
#>----------------------------------------------------<#

USAGE_GUIDE
  )"
}

# ===================================================================
#@		                        GLOBAL TOOLS                         @#
# ===================================================================

#@ Usage display
__help__() {
  printf "%s\n" "$_cmd_USAGEGUIDE"
  exit 0
}

#@ Version display
__version__() {
  printf "%s\n" "$_cmd_VERSION"
  exit 0
}

#@ Command validation tool
__weHave__() {
  if command -v weHave >/dev/null 2>&1; then
    weHave "$@"
  else
    command -v "$@" >/dev/null 2>&1
  fi
}

# ===================================================================
#@		                          OPTIONS			                       @#
# ===================================================================

if __weHave__ getO; then

  #@ Declare user options (Allow multiple flags)
  opts() {
    setup REST
    disp _cmd_USAGEGUIDE -h --help
    disp _cmd_VERSION -v --version
    flag VERBOSE -d --verbose -- "takes no arguments"
    flag PYTHON -p --python -- "takes no arguments"
    flag BC -b --bc -- "takes no arguments"
  }

  #@ Load options
  eval "$(getO opts) exit 1"

else

  #@ Declare user options (One flag per command)
  case "$1" in
  '-h' | '--help') __help__ ;;
  '-v' | '--version') __version__ ;;
  '-d' | '--verbose')
    VERBOSE=true
    shift
    ;;
  '-p' | '--python')
    CALCULATOR="python"
    shift
    ;;
  '-b' | '--bc')
    CALCULATOR="bc"
    shift
    ;;
  *) ;;
  esac
fi

# ===================================================================
#@		                          DEFAULT			                       @#
# ===================================================================

__defaults__() {

  #@ Set python as the default calculator
  CALCULATOR="python"

  #@ Change calculator to BC is requested
  [ "$BC" ] && CALCULATOR="bc"

}

# ===================================================================
#@		                          PROCESS			                       @#
# ===================================================================

__process__() {

  #@ Enable 'python' calculator
  _pc_() {
    if __weHave__ python; then
      python -c "from math import *; result=$*; print (round(result,4))"
    else
      echo "'python' not installed"
      #TODO: add a de
    fi
  }

  #@ Enable 'bc' calculator
  _bc_() {
    if __weHave__ bc; then
      printf "%.4f\n" "$(echo "$*" | bc --mathlib)"
    else
      printf "\'bc\' not found"
    fi
  }

  #@ Calculate based on app selection
  if [ "$CALCULATOR" = "bc" ]; then
    _bc_ "$*"
  elif [ "$CALCULATOR" = "python" ]; then
    _pc_ "$*"
  else
    echo $(("$*"))
  fi

}

# ===================================================================
#@		                           	ERROR			                       @#
# ===================================================================

__error__() {
  case $* in
  -s | --string)
    msg="ðŸŸ¥ Please ensure that a valid equation is entered."
    printf "\n%s\n" "$msg"
    __help__
    exit 1
    ;;
  *) ;;
  esac
}

# ===================================================================
#@		                          CLEANUP			                       @#
# ===================================================================

__cleanup__() {
  unset VERBOSE BC PYTHON CALCULATOR
}

# ===================================================================
#@		                           	 VERBOSE	                       @#
# ===================================================================

__verbose__() {

  CALCULATOR_h1="*** Calculator ***"
  CALCULATOR_tab=$(((${#CALCULATOR_h1} - ${#CALCULATOR}) / 2))

  printf "%s\n" "$CALCULATOR_h1"
  printf "%${CALCULATOR_tab}s"
  printf "%s\n\n" "$CALCULATOR"

  echo "*** Equations ***"
  i=0
  while [ $# -gt 0 ] && i=$((i + 1)); do
    printf "%s | %s == %s\n\n" "$i" "$1" "$(__process__ "$1")"
    shift
  done

}

# ===================================================================
#@		                           	 MAIN			                       @#
# ===================================================================

__main__() {

  #@ Confirm that a string was entered
  [ "$#" -eq 0 ] && __error__ --string

  #@ Process all stings
  while [ $# -gt 0 ]; do
    __process__ "$1"
    shift
  done

}

# ===================================================================
#@		                            RUN	  		                       @#
# ===================================================================

#@ Load internal variables
__info__

#@ Establish defaults
__defaults__

#@ Allow verbose option if requested
if [ "$VERBOSE" ]; then
  __verbose__ "$@"
else
  __main__ "$@"
fi

#@ Remove any leftover variables
__cleanup__
